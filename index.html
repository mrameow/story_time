<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Story Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added DynaPuff Font -->
    <link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Montserrat', sans-serif; /* Keep UI legible */
            background-color: #0f172a;
            animation: colorCycle 30s infinite ease-in-out;
            /* Prevent double-tap zoom on mobile to make play/pause tapping responsive */
            touch-action: manipulation; 
        }

        @keyframes colorCycle {
            0% { background-color: #0f172a; }   /* Slate 900 */
            20% { background-color: #312e81; }  /* Indigo 900 */
            40% { background-color: #4c1d95; }  /* Violet 900 */
            60% { background-color: #831843; }  /* Pink 900 */
            80% { background-color: #701a75; }  /* Fuchsia 900 */
            100% { background-color: #0f172a; } /* Loop back */
        }
        
        /* The TikTok/Reels caption style */
        #caption-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            text-align: center;
            z-index: 20;
            pointer-events: none;
            /* Text Shadow for visibility against any background */
            text-shadow: 
                4px 4px 0 #000,
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }

        .active-word {
            font-family: 'DynaPuff', cursive; /* New Font */
            font-size: 6rem; 
            color: #fff;
            /* text-transform: uppercase;  Keep natural casing */
            line-height: 1.1;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
            white-space: pre-wrap;
            letter-spacing: 1px;
        }

        .active-word.pop {
            transform: scale(1.2) rotate(-2deg); /* Added slight rotation for fun */
            color: #fbbf24; /* Amber-400 for emphasis */
        }

        /* Controls UI - Main Box */
        #controls {
            position: absolute;
            bottom: 110px; /* Moved up to make room for seek bar */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 16px;
            z-index: 30;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #controls.hidden-ui {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(20px);
        }

        /* Seek Bar Wrapper - Always Visible or Separately Controlled */
        #seek-wrapper {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 35; /* Above controls slightly */
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        /* Custom Input Styles */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        /* Seek/Speed Range Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            width: 100%;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fbbf24;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        /* Toggle UI visibility button */
        #toggle-ui {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 40;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
        }

        /* Loading spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .active-word { font-size: 3.5rem; }
            #controls { bottom: 90px; }
            #seek-wrapper { bottom: 20px; }
        }
    </style>
</head>
<body>

    <!-- The Caption Display -->
    <div id="caption-container">
        <div id="word-display" class="active-word">READY</div>
    </div>

    <!-- Hide UI Button -->
    <button id="toggle-ui">Hide UI</button>

    <!-- Controls (Main Inputs) -->
    <div id="controls">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-white font-bold text-lg"><i class="fas fa-book-open mr-2"></i>Story Generator</h2>
            <div class="loader" id="loader"></div>
        </div>

        <input type="text" id="topic-input" 
            placeholder="E.g., AITA for eating my roommate's pizza..." 
            class="w-full bg-gray-800 text-white border border-gray-600 rounded p-3 focus:outline-none focus:border-amber-400 transition-colors mb-2"
        >

        <!-- Voice Selection -->
        <div class="flex gap-2 mb-2">
            <select id="voice-select" class="flex-1 bg-gray-800 text-white border border-gray-600 rounded p-2 text-sm focus:outline-none focus:border-amber-400">
                <option value="">Loading Voices...</option>
            </select>
        </div>

        <!-- Speed Control -->
        <div class="flex items-center gap-2 mb-2 bg-gray-800 p-2 rounded border border-gray-600">
            <span class="text-xs text-gray-400 whitespace-nowrap">Speed: <span id="speed-label" class="text-white font-bold">1.1x</span></span>
            <input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.1">
        </div>

        <!-- Generate Button -->
        <button id="generate-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-4 rounded shadow-lg transform transition active:scale-95 mb-1">
            Generate Story
        </button>

        <!-- Playback Controls -->
        <div class="flex gap-2">
            <button id="play-pause-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded shadow-lg transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-play mr-2"></i>Play
            </button>
            <button id="stop-btn" class="bg-gray-800 hover:bg-red-900 text-white font-bold py-3 px-4 rounded shadow-lg transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-stop"></i>
            </button>
        </div>
        
        <div class="mt-2 text-xs text-gray-400 text-center">
            Tip: Use "Local" voices for best text sync!
        </div>
    </div>

    <!-- Separate Seek Bar Wrapper (Stays Visible) -->
    <div id="seek-wrapper">
        <div class="flex items-center gap-3">
            <!-- Added play icon to seek bar for clarity when main UI hidden -->
            <button id="mini-play-btn" class="text-white hover:text-amber-400 disabled:opacity-50" disabled>
                <i class="fas fa-play"></i>
            </button>
            <span class="text-xs text-gray-300 font-mono">0%</span>
            <input type="range" id="seek-bar" min="0" max="100" value="0" class="focus:outline-none" disabled>
            <span class="text-xs text-gray-300 font-mono">100%</span>
        </div>
    </div>

<script>
    /**
     * Logic for Story Generation and TTS
     */
    const wordDisplay = document.getElementById('word-display');
    const topicInput = document.getElementById('topic-input');
    const generateBtn = document.getElementById('generate-btn');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const miniPlayBtn = document.getElementById('mini-play-btn'); 
    const stopBtn = document.getElementById('stop-btn');
    const seekBar = document.getElementById('seek-bar');
    const loader = document.getElementById('loader');
    const toggleUiBtn = document.getElementById('toggle-ui');
    const controls = document.getElementById('controls');
    const seekWrapper = document.getElementById('seek-wrapper');
    const voiceSelect = document.getElementById('voice-select');
    const speedRange = document.getElementById('speed-range');
    const speedLabel = document.getElementById('speed-label');

    let currentStoryText = "";
    const synthesis = window.speechSynthesis;
    window.currentUtterance = null; 
    let currentOffset = 0; 
    let voices = [];

    // Initialize Voices
    function populateVoiceList() {
        // Wait for voices to be available
        voices = synthesis.getVoices().sort((a, b) => {
            const aname = a.name.toUpperCase();
            const bname = b.name.toUpperCase();
            // Prioritize Local Voices
            if (a.localService && !b.localService) return -1;
            if (!a.localService && b.localService) return 1;
            if (aname < bname) return -1;
            if (aname > bname) return 1;
            return 0;
        });

        // Filter for English primarily
        const englishVoices = voices.filter(voice => voice.lang.includes('en'));
        const displayVoices = englishVoices.length > 0 ? englishVoices : voices;

        voiceSelect.innerHTML = '';
        displayVoices.forEach((voice) => {
            const option = document.createElement('option');
            const localLabel = voice.localService ? " (Local - Best Sync)" : " (Network)";
            option.textContent = `${voice.name}${localLabel}`;
            option.value = voice.name;
            
            // Auto-select priority: Local English -> Google US English -> First available
            if (voice.localService && voice.lang.includes("en-US")) {
                 if (!voiceSelect.value) option.selected = true; // Select first good match
            }
            
            voiceSelect.appendChild(option);
        });

        // Fallback selection if no good local voice found
        if (!voiceSelect.value && displayVoices.length > 0) {
            voiceSelect.selectedIndex = 0;
        }
    }

    // Chrome often loads voices asynchronously
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
    }
    // Also try immediately
    setTimeout(populateVoiceList, 100);

    // Speed Control Handler
    speedRange.addEventListener('input', (e) => {
        speedLabel.textContent = e.target.value + 'x';
    });
    
    // When speed or voice changes during playback, restart from current spot
    const updatePlaybackSettings = () => {
        if (!synthesis.paused && !synthesis.speaking) return; // Not playing
        // If playing or paused, restart to apply settings
        speakStory(currentOffset);
    };

    speedRange.addEventListener('change', updatePlaybackSettings); // On drag release
    voiceSelect.addEventListener('change', updatePlaybackSettings);


    // Toggle UI (Only toggles the main box, keeps seek bar)
    toggleUiBtn.addEventListener('click', () => {
        controls.classList.toggle('hidden-ui');
        toggleUiBtn.textContent = controls.classList.contains('hidden-ui') ? 'Show UI' : 'Hide UI';
    });

    // Global Tap to Play/Pause (When UI is hidden)
    document.body.addEventListener('click', (e) => {
        // Condition: Main UI is hidden
        if (controls.classList.contains('hidden-ui')) {
            // Check if click target is NOT an interactive element (buttons, seek bar, etc)
            const isInteractive = e.target.closest('button') || 
                                  e.target.closest('input') || 
                                  e.target.closest('#seek-wrapper');
            
            if (!isInteractive) {
                togglePlayPauseLogic();
                showTemporaryVisualFeedback();
            }
        }
    });

    // Generate Story
    generateBtn.addEventListener('click', async () => {
        const topic = topicInput.value.trim() || "A generic dramatic confession";
        
        handleStop();
        
        loader.style.display = 'block';
        generateBtn.disabled = true;
        wordDisplay.textContent = "GENERATING...";
        
        try {
            const apiKey = config.MY_API_KEY; // Set by environment
            
            const prompt = `Write a short, engaging, first-person Reddit-style story (like r/confessions, r/AITA, or r/TIFU). 
            Topic: ${topic}.
            Rules:
            1. Keep it under 150 words.
            2. Make it sound conversational and dramatic.
            3. Do not include a title or "TLDR".
            4. Start directly with the story.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            currentStoryText = data.candidates[0].content.parts[0].text;
            currentStoryText = currentStoryText.replace(/\*/g, '');

            wordDisplay.textContent = "PRESS PLAY";
            
            // Enable all controls
            playPauseBtn.disabled = false;
            miniPlayBtn.disabled = false;
            stopBtn.disabled = false;
            seekBar.disabled = false;
            seekBar.value = 0;
            
        } catch (err) {
            console.error(err);
            wordDisplay.textContent = "ERROR";
            setTimeout(() => wordDisplay.textContent = "TRY AGAIN", 2000);
        } finally {
            loader.style.display = 'none';
            generateBtn.disabled = false;
        }
    });

    // Play/Pause Handlers
    playPauseBtn.addEventListener('click', togglePlayPauseLogic);
    miniPlayBtn.addEventListener('click', togglePlayPauseLogic); // Mini button handler

    function togglePlayPauseLogic() {
        if (!currentStoryText) return;

        if (synthesis.paused) {
            synthesis.resume();
            updatePlayButtonState('playing');
        } else if (synthesis.speaking) {
            synthesis.pause();
            updatePlayButtonState('paused');
        } else {
            speakStory(currentOffset || 0);
        }
    }

    // Stop Button
    stopBtn.addEventListener('click', handleStop);

    // Seek Bar Handler
    seekBar.addEventListener('input', (e) => {
        if (!currentStoryText) return;
        const percent = parseInt(e.target.value);
        const charIndex = Math.floor((percent / 100) * currentStoryText.length);
        speakStory(charIndex);
    });

    function handleStop() {
        synthesis.cancel();
        updatePlayButtonState('stopped');
        currentOffset = 0;
        seekBar.value = 0;
        if (currentStoryText) wordDisplay.textContent = "PRESS PLAY";
        else wordDisplay.textContent = "READY";
    }

    function updatePlayButtonState(state) {
        // Main Button Updates
        if (state === 'playing') {
            playPauseBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
            playPauseBtn.classList.remove('bg-green-600', 'bg-gray-700');
            playPauseBtn.classList.add('bg-amber-600');
            
            // Mini Button Icon
            miniPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else if (state === 'paused') {
            playPauseBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            playPauseBtn.classList.remove('bg-amber-600', 'bg-gray-700');
            playPauseBtn.classList.add('bg-green-600');

            miniPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            playPauseBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Play';
            playPauseBtn.classList.remove('bg-green-600', 'bg-amber-600');
            playPauseBtn.classList.add('bg-gray-700');

            miniPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    }

    // Temporary Visual Feedback for Tap (Subtle flash)
    function showTemporaryVisualFeedback() {
        // Just a subtle flash on word display to acknowledge tap
        wordDisplay.style.opacity = '0.5';
        setTimeout(() => wordDisplay.style.opacity = '1', 100);
    }

    function speakStory(startIndex = 0) {
        if (window.currentUtterance) {
            window.currentUtterance.onend = null;
        }
        synthesis.cancel();

        currentOffset = startIndex;

        if (startIndex >= currentStoryText.length) {
            handleStop();
            return;
        }

        setTimeout(() => {
            if (!currentStoryText) return;

            const textToSpeak = currentStoryText.slice(startIndex);
            window.currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            const u = window.currentUtterance;
            
            // Voice Selection Logic
            const selectedVoiceName = voiceSelect.value;
            const selectedSpeed = parseFloat(speedRange.value);
            
            // Try to find the user's selected voice
            let preferredVoice = voices.find(v => v.name === selectedVoiceName);
            
            // Intelligent Fallback: Prefer LOCAL voices if the selected one is missing or invalid
            if (!preferredVoice) preferredVoice = voices.find(v => v.lang.includes("en") && v.localService);
            if (!preferredVoice) preferredVoice = voices.find(v => v.name.includes("Google US English"));
            
            if (preferredVoice) u.voice = preferredVoice;
            
            // Apply Speed
            u.rate = selectedSpeed;
            u.pitch = 1.0;

            u.onboundary = (event) => {
                if (event.name === 'word') {
                    const trueIndex = currentOffset + event.charIndex;
                    
                    // Update Seek Bar 
                    const progress = (trueIndex / currentStoryText.length) * 100;
                    seekBar.value = progress;

                    const textRem = textToSpeak.slice(event.charIndex);
                    // Improved Regex to grab word including punctuation attached to it (more natural reading)
                    // but display just the word for cleaner look if desired.
                    const match = textRem.match(/\S+/); 
                    if (match) {
                        updateDisplay(match[0]);
                    }
                }
            };

            u.onstart = () => updatePlayButtonState('playing');

            u.onend = () => {
                if (seekBar.value > 98) {
                    wordDisplay.classList.remove('pop');
                    wordDisplay.textContent = "THE END";
                    updatePlayButtonState('stopped');
                    seekBar.value = 100;
                }
            };
            
            u.onerror = (e) => {
                if (e.error !== 'canceled' && e.error !== 'interrupted') {
                    console.error("Speech Error Details:", e.error, e);
                    updatePlayButtonState('stopped');
                }
            }

            synthesis.speak(u);
            
            if (synthesis.paused) synthesis.resume();

        }, 50);
    }

    function updateDisplay(word) {
        if(!word) return;
        wordDisplay.textContent = word;
        wordDisplay.classList.remove('pop');
        void wordDisplay.offsetWidth;
        wordDisplay.classList.add('pop');
    }
</script>
</body>
</html>
